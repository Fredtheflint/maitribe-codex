<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiTribe Admin</title>
<meta name="robots" content="noindex, nofollow">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --deep-forest: #1a2f1a;
    --sage: #7c9a6e;
    --cream: #e8e4df;
    --gold: #c9b88c;
    --bg: #0a0a0a;
    --card-bg: rgba(26, 47, 26, 0.25);
    --card-border: rgba(124, 154, 110, 0.2);
    --text: #e8e4df;
    --text-dim: rgba(232, 228, 223, 0.5);
    --radius: 16px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  h1, h2, h3 { font-family: 'Cormorant Garamond', serif; font-weight: 600; }

  .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--card-border);
  }
  .header h1 { font-size: 1.8rem; color: var(--gold); }
  .header .subtitle { color: var(--text-dim); font-size: 0.85rem; }

  /* Config bar */
  .config-bar {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  .config-bar .field { display: flex; flex-direction: column; gap: 0.3rem; flex: 1; min-width: 200px; }
  .config-bar label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
  .config-bar input {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 0.6rem 0.8rem;
    color: var(--text);
    font-family: 'DM Sans', monospace;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .config-bar input:focus { border-color: var(--sage); }
  .config-bar input::placeholder { color: var(--text-dim); }

  .btn {
    background: linear-gradient(135deg, var(--sage), var(--deep-forest));
    color: var(--cream);
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.4rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
  }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Status */
  .status {
    font-size: 0.8rem;
    padding: 0.5rem 0;
    min-height: 1.5rem;
  }
  .status.error { color: #e57373; }
  .status.ok { color: var(--sage); }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2.5rem;
  }
  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 1.2rem;
    backdrop-filter: blur(12px);
    text-align: center;
  }
  .stat-card .number {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.2rem;
    font-weight: 600;
    color: var(--gold);
    line-height: 1.1;
  }
  .stat-card .label {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 0.3rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  /* Table */
  .table-section h2 {
    font-size: 1.3rem;
    color: var(--cream);
    margin-bottom: 1rem;
  }
  .table-wrap {
    overflow-x: auto;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    backdrop-filter: blur(12px);
  }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th {
    text-align: left;
    padding: 0.8rem 1rem;
    font-weight: 600;
    color: var(--sage);
    border-bottom: 1px solid var(--card-border);
    white-space: nowrap;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  td {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid rgba(124, 154, 110, 0.08);
    color: var(--text);
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(124, 154, 110, 0.06); }
  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  .badge.yes { background: rgba(124, 154, 110, 0.25); color: var(--sage); }
  .badge.no { background: rgba(229, 115, 115, 0.15); color: #e57373; }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  @media (max-width: 600px) {
    .container { padding: 1rem; }
    .header h1 { font-size: 1.4rem; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>MaiTribe Admin</h1>
      <div class="subtitle">Dashboard &middot; Internal use only</div>
    </div>
    <div class="subtitle" id="last-refreshed"></div>
  </div>

  <div class="config-bar">
    <div class="field">
      <label>Supabase URL</label>
      <input id="sb-url" type="url" placeholder="https://xxxx.supabase.co" />
    </div>
    <div class="field">
      <label>Service Role Key</label>
      <input id="sb-key" type="password" placeholder="eyJ..." />
    </div>
    <button class="btn" id="btn-load" onclick="loadDashboard()">Load</button>
  </div>
  <div class="status" id="status"></div>

  <div id="dashboard" style="display:none;">
    <div class="stats-grid">
      <div class="stat-card"><div class="number" id="s-users">-</div><div class="label">Total Users</div></div>
      <div class="stat-card"><div class="number" id="s-onboarded">-</div><div class="label">Onboarded</div></div>
      <div class="stat-card"><div class="number" id="s-checkins">-</div><div class="label">Check-ins</div></div>
      <div class="stat-card"><div class="number" id="s-conversations">-</div><div class="label">Conversations</div></div>
      <div class="stat-card"><div class="number" id="s-reminders">-</div><div class="label">Reminders Sent</div></div>
      <div class="stat-card"><div class="number" id="s-waitlist">-</div><div class="label">Waitlist</div></div>
    </div>

    <div class="table-section">
      <h2>Recent Users</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Created</th>
              <th>Onboarding</th>
              <th>Tier</th>
              <th>Language</th>
            </tr>
          </thead>
          <tbody id="users-table"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // Persist credentials in sessionStorage
  (function restore() {
    const u = sessionStorage.getItem("maitribe.admin.url");
    const k = sessionStorage.getItem("maitribe.admin.key");
    if (u) $("sb-url").value = u;
    if (k) $("sb-key").value = k;
  })();

  function setStatus(msg, isError) {
    const el = $("status");
    el.textContent = msg;
    el.className = "status " + (isError ? "error" : "ok");
  }

  async function sbFetch(url, key, path, params) {
    const qs = params ? "?" + new URLSearchParams(params).toString() : "";
    const res = await fetch(url + "/rest/v1/" + path + qs, {
      headers: {
        "apikey": key,
        "Authorization": "Bearer " + key,
        "Content-Type": "application/json",
        "Prefer": "count=exact"
      }
    });
    if (!res.ok) throw new Error(path + ": " + res.status + " " + res.statusText);
    const count = res.headers.get("content-range");
    const data = await res.json();
    return { data, count: count ? parseInt(count.split("/")[1]) : data.length };
  }

  async function loadDashboard() {
    const url = $("sb-url").value.trim().replace(/\/$/, "");
    const key = $("sb-key").value.trim();
    if (!url || !key) { setStatus("Please enter both URL and key.", true); return; }

    sessionStorage.setItem("maitribe.admin.url", url);
    sessionStorage.setItem("maitribe.admin.key", key);

    $("btn-load").disabled = true;
    setStatus("Loading...");

    try {
      const [users, onboarded, checkins, conversations, reminders, waitlist, recentUsers] = await Promise.all([
        sbFetch(url, key, "users", { select: "id", limit: "0" }),
        sbFetch(url, key, "users", { select: "id", onboarding_completed: "eq.true", limit: "0" }),
        sbFetch(url, key, "checkins", { select: "id", limit: "0" }),
        sbFetch(url, key, "conversations", { select: "id", limit: "0" }),
        sbFetch(url, key, "reminders", { select: "id", sent: "eq.true", limit: "0" }).catch(() => ({ count: 0 })),
        sbFetch(url, key, "waitlist", { select: "id", limit: "0" }).catch(() => ({ count: 0 })),
        sbFetch(url, key, "users", {
          select: "email,name,display_name,created_at,onboarding_completed,subscription_tier,language",
          order: "created_at.desc",
          limit: "50"
        })
      ]);

      $("s-users").textContent = users.count;
      $("s-onboarded").textContent = onboarded.count;
      $("s-checkins").textContent = checkins.count;
      $("s-conversations").textContent = conversations.count;
      $("s-reminders").textContent = reminders.count;
      $("s-waitlist").textContent = waitlist.count;

      const tbody = $("users-table");
      if (recentUsers.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users yet.</td></tr>';
      } else {
        tbody.innerHTML = recentUsers.data.map((u) => {
          const date = new Date(u.created_at);
          const formatted = date.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" })
            + " " + date.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
          const ob = u.onboarding_completed;
          return '<tr>'
            + '<td>' + esc(u.email || "-") + '</td>'
            + '<td>' + esc(u.display_name || u.name || "-") + '</td>'
            + '<td>' + formatted + '</td>'
            + '<td><span class="badge ' + (ob ? "yes" : "no") + '">' + (ob ? "Done" : "Pending") + '</span></td>'
            + '<td>' + esc(u.subscription_tier || "free") + '</td>'
            + '<td>' + esc((u.language || "en").toUpperCase()) + '</td>'
            + '</tr>';
        }).join("");
      }

      $("dashboard").style.display = "block";
      $("last-refreshed").textContent = "Updated " + new Date().toLocaleTimeString();
      setStatus("Loaded successfully.");
    } catch (err) {
      setStatus("Error: " + err.message, true);
    } finally {
      $("btn-load").disabled = false;
    }
  }

  function esc(str) {
    const d = document.createElement("div");
    d.textContent = str;
    return d.innerHTML;
  }

  // Auto-load if credentials exist
  if ($("sb-url").value && $("sb-key").value) loadDashboard();
</script>
</body>
</html>
